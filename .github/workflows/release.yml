name: Build and Release Action

on:
  push:
    tags:
      - "v*.*.*"

env:
  REGISTRY: ghcr.io

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: docker
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          REGISTRY: ${{ env.REGISTRY }}
          REPOSITORY: ${{ github.repository }}
        run: |
          TAG="$GITHUB_REF_NAME"
          MAJOR="${TAG%%.*}"
          IMAGE_PATH="$REGISTRY/$REPOSITORY"
          
          docker build -t "$IMAGE_PATH:$TAG" -t "$IMAGE_PATH:$MAJOR" .
          docker push "$IMAGE_PATH:$TAG"
          docker push "$IMAGE_PATH:$MAJOR"
          
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_PATH:$TAG")
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Update action.yml with Image Digest
        env:
          DIGEST: ${{ steps.docker.outputs.digest }}
        run: |
          sed -i "s|image: \"docker://.*\"|image: \"docker://$DIGEST\"|g" action.yml

      - name: Create GitHub App Token
        id: token
        uses: ./
        with:
          app_id: ${{ secrets.BOT_GITHUB_APP_ID }}
          kms_key_id: ${{ secrets.KMS_KEY_ID }}
          kms_keyring_id: ${{ secrets.KMS_KEYRING_ID }}
          kms_location: ${{ vars.KMS_LOCATION }}
          kms_project_id: ${{ vars.KMS_PROJECT_ID }}
          owner: yagihash
          repositories: |
            ghat
          permission_contents: write

      - name: Setup git
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          gh auth setup-git

      - name: Commit and Force-Push Tags
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          TAG="$GITHUB_REF_NAME"
          MAJOR="${TAG%%.*}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add action.yml
          git commit -m "chore: update action.yml to use image digest for $TAG [skip ci]" || echo "No changes to commit"
          
          git tag -fa "$TAG" -m "Release $TAG"
          git tag -fa "$MAJOR" -m "Update $MAJOR to $TAG"
          
          git push origin "$TAG" --force
          git push origin "$MAJOR" --force
