name: Build and Release Action

on:
  push:
    tags:
      - "v*.*.*"

env:
  REGISTRY: ghcr.io

jobs:
  release:
    runs-on: ubuntu-latest
    environment: main
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: docker
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          REGISTRY: ${{ env.REGISTRY }}
          REPOSITORY: ${{ github.repository }}
        run: |
          TAG="$GITHUB_REF_NAME"
          MAJOR="${TAG%%.*}"
          IMAGE_PATH="$REGISTRY/$REPOSITORY"
          
          docker build -t "$IMAGE_PATH:$TAG" -t "$IMAGE_PATH:$MAJOR" .
          docker push "$IMAGE_PATH:$TAG"
          docker push "$IMAGE_PATH:$MAJOR"
          
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_PATH:$TAG")
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Create GitHub App Token
        id: token
        uses: ./
        with:
          app_id: ${{ secrets.BOT_GITHUB_APP_ID }}
          kms_key_id: ${{ secrets.KMS_KEY_ID }}
          kms_keyring_id: ${{ secrets.KMS_KEYRING_ID }}
          kms_location: ${{ vars.KMS_LOCATION }}
          kms_project_id: ${{ vars.KMS_PROJECT_ID }}
          owner: yagihash
          repositories: |
            ghat
          permission_contents: write

      - name: Setup git
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          gh auth setup-git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update action.yml and push new tag
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          DIGEST: ${{ steps.docker.outputs.digest }}
        run: |
          TAG="$GITHUB_REF_NAME"
          MAJOR="${TAG%%.*}"
          
          sed -i "s|image: \"docker://.*\"|image: \"docker://$DIGEST\"|g" action.yml
          
          git add action.yml
          git commit -m "chore: update action.yml to use image digest for $TAG [skip ci]" || echo "No changes to commit"
          
          git tag -fa "$TAG" -m "Release $TAG"
          git tag -fa "$MAJOR" -m "Update $MAJOR to $TAG"
          
          git push origin "$TAG" --force
          git push origin "$MAJOR" --force

      - name: Run pinact
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          curl -L -o pinact.tar.gz 'https://github.com/suzuki-shunsuke/pinact/releases/download/v3.8.0/pinact_linux_amd64.tar.gz'
          tar xzf pinact.tar.gz pinact
          
          ./pinact run README.md -u
          
          git add README.md
          git commit -m "chore: update README.md to refer latest version" || echo "No changes to commit"
          
          git push origin main
