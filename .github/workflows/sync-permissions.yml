name: Sync GitHub App Permissions

on:
  push:
    paths:
      - ".github/workflows/sync-permissions.yml"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-slim
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Checkout octokit/openapi
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          repository: "octokit/openapi"
          path: "./openapi"

      - name: Update action.yml
        run: |
          # --- 1. inputs ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–° ---
          # ãƒ•ã‚¡ã‚¤ãƒ«å†’é ­ã‹ã‚‰ "repositories:" ãƒ–ãƒ­ãƒƒã‚¯ã®æœ«å°¾ï¼ˆrequired: falseï¼‰ã¾ã§ã‚’æŠ½å‡º
          sed -n '1,/repositories:/p; /repositories:/,/required: false/p' action.yml | sed '$d' > action.yml.new
          
          # inputs ç”¨ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å®šç¾©ã‚’è¿½è¨˜
           jq -r '.components.schemas["app-permissions"].properties | keys_unsorted[] | "    - \${{ inputs.permission-\(. | gsub("_"; "-")) }}"' ./openapi/generated/api.github.com.json >> action.yml.new
          
          # --- 2. outputs ã¨ runs.args é–‹å§‹ä½ç½®ã¾ã§ã‚’æŠ½å‡º ---
          echo "" >> action.yml.new
          sed -n '/outputs:/,/args:/p' action.yml >> action.yml.new
          
          # --- 3. runs.args ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–° ---
          # å›ºå®šå¼•æ•°ï¼ˆapp_id ã‹ã‚‰ repositories ã¾ã§ï¼‰ã‚’ä¸€æ‹¬æŠ½å‡º
          sed -n '/- \${{ inputs.app_id }}/,/- \${{ inputs.repositories }}/p' action.yml >> action.yml.new
          
          # jqã§å…¨ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ args ã«å‹•çš„è¿½åŠ 
          jq -r '.components.schemas["app-permissions"].properties | keys_unsorted[] | "    - \${{ inputs.permission-\(. | gsub("_"; "-")) }}"' ./openapi/generated/api.github.com.json >> action.yml.new
          
          # --- 4. æ®‹ã‚Šã® entrypoint ä»¥é™ã‚’å¾©å…ƒ ---
          sed -n '/entrypoint:/,$p' action.yml >> action.yml.new
          
          mv action.yml.new action.yml

      - name: Create Pull Request with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Git ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã« GitHub CLI ã‚’åˆ©ç”¨
          gh auth setup-git
          
          BRANCH_NAME="sync-permissions-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ PR ã‚’ä½œæˆ
          if [[ -n $(git status --porcelain action.yml) ]]; then
            git checkout -b "$BRANCH_NAME"
            git add action.yml
            git commit -m "chore: sync GitHub App permissions"
            git push origin "$BRANCH_NAME" --force
            
            gh pr create \
              --title "ğŸ¤– Sync GitHub App Permissions" \
              --body "This PR updates \`action.yml\` inputs and args based on the latest GitHub App permissions from octokit/openapi." \
              --base main \
              --head "$BRANCH_NAME" || echo "PR already exists or was updated."
          else
            echo "No changes detected in action.yml"
          fi
